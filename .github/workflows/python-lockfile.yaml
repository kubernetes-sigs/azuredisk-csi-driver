name: Python Lockfile Validation
on:
    pull_request: {}
    push: {}
jobs:
    validate-lockfile:
        name: Validate Python Lockfile
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v5

            - name: Validate lockfile is up to date
              run: |
                  uv pip compile --python-platform linux --generate-hashes hack/requirements.in -o hack/requirements.txt.tmp
                  if ! diff -q hack/requirements.txt hack/requirements.txt.tmp > /dev/null 2>&1; then
                      echo "ERROR: Python lockfile is out of date!"
                      echo ""
                      echo "Run 'make update-deps' locally and commit the changes."
                      echo ""
                      echo "Diff:"
                      diff hack/requirements.txt hack/requirements.txt.tmp || true
                      exit 1
                  fi
                  echo "Lockfile is up to date."
                  rm -f hack/requirements.txt.tmp
